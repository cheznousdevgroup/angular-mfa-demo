<div class="security-container">
  <div class="container py-4">
    <!-- Messages de succès / erreur -->
    <div *ngIf="successMessage" class="alert alert-success mb-4 slide-in">
      <i class="fas fa-check-circle me-2"></i>{{ successMessage }}
    </div>
    <div *ngIf="errorMessage" class="alert alert-danger mb-4 slide-in">
      <i class="fas fa-exclamation-circle me-2"></i>{{ errorMessage }}
    </div>

    <!-- Authentification à deux facteurs -->
    <div class="card mb-4">
      <div class="card-header">
        <h2 class="h5 mb-0">Authentification à deux facteurs (2FA)</h2>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <p class="mb-1">
              <span
                *ngIf="currentUser?.mfaEnabled"
                class="badge bg-success me-2"
                >Activée</span
              >
              <span
                *ngIf="!currentUser?.mfaEnabled"
                class="badge bg-warning text-dark me-2"
                >Désactivée</span
              >
              Ajoutez une couche de sécurité supplémentaire à votre compte
            </p>
            <p class="text-muted small mb-0" *ngIf="currentUser?.mfaEnabled">
              Dernière vérification :
              {{
                currentUser?.lastMfaVerification | date : "dd/MM/yyyy à HH:mm"
              }}
            </p>
          </div>

          <div>
            <button
              *ngIf="!currentUser?.mfaEnabled"
              class="btn btn-primary btn-sm"
              (click)="onEnableMfa()"
            >
              <i class="fas fa-shield-alt me-1"></i>Activer 2FA
            </button>

            <button
              *ngIf="currentUser?.mfaEnabled"
              class="btn btn-outline-danger btn-sm"
              (click)="openDisableMfaModal()"
            >
              <i class="fas fa-times-circle me-1"></i>Désactiver 2FA
            </button>
          </div>
        </div>

        <div class="alert alert-info" *ngIf="!currentUser?.mfaEnabled">
          <i class="fas fa-info-circle me-2"></i>
          Nous recommandons fortement l'activation de l'authentification à deux
          facteurs pour protéger votre compte contre les accès non autorisés.
        </div>
      </div>
    </div>

    <!-- Options de récupération -->
    <div class="card mb-4" *ngIf="currentUser?.mfaEnabled">
      <div class="card-header">
        <h2 class="h5 mb-0">Options de récupération</h2>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <p class="mb-0">Codes de secours</p>
            <p class="text-muted small mb-0">
              {{ remainingBackupCodes }} sur {{ totalBackupCodes }} restants
            </p>
          </div>

          <div>
            <button
              class="btn btn-outline-primary btn-sm"
              (click)="openBackupCodesModal()"
            >
              <i class="fas fa-eye me-1"></i>Voir les codes
            </button>
            <button
              class="btn btn-outline-primary btn-sm ms-2"
              (click)="regenerateBackupCodes()"
            >
              <i class="fas fa-sync-alt me-1"></i>Générer de nouveaux codes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Activité récente -->
    <div class="card">
      <div class="card-header">
        <h2 class="h5 mb-0">Activité récente</h2>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Date</th>
                <th>Activité</th>
                <th>Adresse IP</th>
                <th>Appareil</th>
              </tr>
            </thead>
            <tbody>
              <!-- Activités de l'utilisateur -->
              <ng-container>
                <tr *ngFor="let activity of activities">
                  <td>{{ activity.timestamp | date : "dd/MM/yyyy HH:mm" }}</td>
                  <td>{{ activity.action }}</td>
                  <td>{{ activity.ipAddress }}</td>
                  <td>{{ activity.device }}</td>
                </tr>
                <tr *ngIf="activities.length === 0">
                  <td colspan="4" class="text-center py-4">
                    <i class="fas fa-info-circle me-2"></i>Aucune activité
                    récente à afficher
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour désactiver MFA -->
<div
  class="modal"
  [class.show]="showDisableMfaModal"
  [style.display]="showDisableMfaModal ? 'block' : 'none'"
  tabindex="-1"
  role="dialog"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Désactiver l'authentification à deux facteurs
        </h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeDisableMfaModal()"
        ></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning mb-4">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Attention :</strong> La désactivation de l'authentification à
          deux facteurs réduira la sécurité de votre compte.
        </div>

        <p>
          Pour désactiver l'authentification à deux facteurs, veuillez saisir
          votre mot de passe et le code de vérification actuel de votre
          application d'authentification.
        </p>

        <form [formGroup]="disableMfaForm">
          <div class="form-group mb-3">
            <label for="password">Mot de passe</label>
            <input
              type="password"
              id="password"
              class="form-control auth-input"
              formControlName="password"
              placeholder="Entrez votre mot de passe"
            />

            <div
              *ngIf="
                disableMfaForm.get('password')?.invalid &&
                (disableMfaForm.get('password')?.dirty ||
                  disableMfaForm.get('password')?.touched)
              "
              class="text-danger mt-2"
            >
              <small
                *ngIf="disableMfaForm.get('password')?.errors?.['required']"
              >
                Le mot de passe est requis.
              </small>
            </div>
          </div>

          <div class="form-group mb-4">
            <label for="verificationCode">Code de vérification</label>
            <input
              type="text"
              id="verificationCode"
              class="form-control auth-input verification-code-input"
              formControlName="verificationCode"
              placeholder="Code à 6 chiffres"
              maxlength="6"
            />

            <div
              *ngIf="
                disableMfaForm.get('verificationCode')?.invalid &&
                (disableMfaForm.get('verificationCode')?.dirty ||
                  disableMfaForm.get('verificationCode')?.touched)
              "
              class="text-danger mt-2"
            >
              <small
                *ngIf="disableMfaForm.get('verificationCode')?.errors?.['required']"
              >
                Le code de vérification est requis.
              </small>
              <small
                *ngIf="disableMfaForm.get('verificationCode')?.errors?.['minlength'] ||
                          disableMfaForm.get('verificationCode')?.errors?.['maxlength']"
              >
                Le code de vérification doit contenir 6 chiffres.
              </small>
            </div>

            <div class="text-muted text-center mt-2 small">
              <p>
                Pour la démonstration, utilisez le code <strong>123456</strong>
              </p>
            </div>
          </div>

          <div *ngIf="errorMessage" class="alert alert-danger mb-4">
            {{ errorMessage }}
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeDisableMfaModal()"
        >
          Annuler
        </button>
        <button
          type="button"
          class="btn btn-danger"
          [disabled]="disableMfaForm.invalid || isSubmitting"
          (click)="onDisableMfa()"
        >
          <span
            *ngIf="isSubmitting"
            class="spinner-border spinner-border-sm me-2"
            aria-hidden="true"
          ></span>
          Désactiver 2FA
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour les codes de secours -->
<div
  class="modal"
  [class.show]="showBackupCodesModal"
  [style.display]="showBackupCodesModal ? 'block' : 'none'"
  tabindex="-1"
  role="dialog"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Codes de secours</h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeBackupCodesModal()"
        ></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">
          Ces codes de secours peuvent être utilisés pour accéder à votre compte
          si vous perdez votre appareil d'authentification. Chaque code ne peut
          être utilisé qu'une seule fois.
        </p>

        <div class="backup-codes-grid mb-3" id="printable-backup-codes">
          <div
            *ngFor="let code of backupCodes"
            class="backup-code"
            [class.text-muted]="code.used"
          >
            {{ code.code }}
            <small *ngIf="code.used" class="text-muted ms-2">(Utilisé)</small>
          </div>

          <div
            *ngIf="backupCodes.length === 0"
            class="text-center p-3 bg-light rounded"
          >
            <i class="fas fa-info-circle me-2"></i>Aucun code de secours
            disponible
          </div>
        </div>

        <div class="d-grid gap-2">
          <button
            type="button"
            class="btn btn-outline-primary"
            (click)="copyBackupCodes()"
            [disabled]="backupCodes.length === 0"
          >
            <i class="fas fa-copy me-1"></i> Copier tous les codes
          </button>

          <button
            type="button"
            class="btn btn-outline-primary"
            (click)="printBackupCodes()"
            [disabled]="backupCodes.length === 0"
          >
            <i class="fas fa-print me-1"></i> Imprimer les codes
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeBackupCodesModal()"
        >
          Fermer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay lorsqu'un modal est affiché -->
<div
  class="modal-backdrop fade show"
  *ngIf="showDisableMfaModal || showBackupCodesModal"
></div>
